
# FRED Yocto Layer

This is a Yocto layer to include [FRED](http://fred.santannapisa.it/) into to a Linux image generated by petalinux.

## Dependencies

This layer depends on:

* URI: git://git.yoctoproject.org/poky
  * branch: master
  * revision: HEAD

* URI: git://git.openembedded.org/meta-openembedded
  * layers: meta-oe
  * branch: master
  * revision: HEAD

## Choosing the petalinux and Yocto versions

In this tutorial we are using **petalinux 2020.2** and it assumes it is already installed. According to this [page](https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841883/Yocto), petalinux 2020.2 is associated with Yocto 3.0 (zeus) and Linux kernel 5.4. This information is important because, in the future when we need to update petalinux version, we have to change the Yocto version in `meta-fred` by changing this file `conf/layer.conf`. Currently this file says that `meta-fred` is compatible with Yocto `zeus`. 

```cmake
LAYERSERIES_COMPAT_meta-fred = "zeus"
```
In fact, 2020.1 is the oldest supported version of petalinux. The recipe `recipes-kernel/fpga-mgr-zynqmp-drv/fpga-mgr-zynqmp-drv_1.0.bb` depends on an update of the `fpga-mgr` kernel module that was only inserted in Linux kernel 5.4. Except for this recipe, meta-fred would *probably* be compatible with older petalinux versions too.

## Supported FPGA platforms 

FRED is tested in zynq and zynqmp devices, namely zcu102-zynqmp, pynq-z1, and Ultra96-zynqmp. 
Petalinux/Yocto has a variable called `MACHINE` that specifies the target hardware. This variable is automatically set when we assign a XSA or BSP file to a petalinux project. One can check the list of Xilinx machines in the directory `./components/yocto/layers/meta-xilinx/meta-xilinx-bsp/conf/machine/` under a petalinux project. In the petalinux flow, `MACHINE` can be viewed in  *petalinux-config --> Yocto settings --> () MACHINE NAME.*

## Building a Standard petalinux Project for a Zynq device

Follow the standard steps to build a petalinux project for a zynq device, in this case the Pynq board:

```bash
 $ source /storage/Xilinx/PetaLinux/2020.2/tool/settings.sh
 $ petalinux-create --type project --template zynq --name pynq-2020.2
 $ cd pynq-2020.2/
 $ petalinux-config --get-hw-description /storage/Xilinx/PetaLinux/2020.2/pynq-z1-2020.2.xsa
```
The reference XSA file for Zynq board is built based on this [repository](https://github.com/Xilinx/PYNQ.git) using the same petalinux version.

Let's run the `petalinux-config` to configure some minimal parameters:
```bash
 $ petalinux-config
```
Select at least these options:

```
Subsystem AUTO Hardware Settings  ---> Ethernet Settings ---> Randomise MAC address
Image Packaging Configuration  ---> Root filesystem type (INITRD)  ---> EXT4 (SD/eMMC/SATA/USB) 
```

Save the configuration and press ESC until quit the application. Finally, build the image with the following command:

```bash
 $ petalinux-build
```

This last command takes a long time. Go take a coffee !

## Building a Standard petalinux Project for a ZynqMP device

This is the procedure for Zynq Ultra Scale+, in this case the zcu102 board:

```bash
 $ source /storage/Xilinx/PetaLinux/2020.2/tool/settings.sh
 $ petalinux-create -t project -s /storage/Xilinx/PetaLinux/2020.2/xilinx-zcu102-v2020.2-final.bsp
 $ cd xilinx-zcu102-2020.2/
```

The ZCU102 PetaLinux BSP file can be downloaded from [here](https://www.xilinx.com/member/forms/download/design-license-zcu102-base.html?filename=xilinx_zcu102_base_202010_1.zip).

Let's run the `petalinux-config` to configure some minimal parameters:
```bash
 $ petalinux-config
```
Select at least these options:

```
Subsystem AUTO Hardware Settings  ---> Ethernet Settings ---> Randomise MAC address
Image Packaging Configuration  ---> Root filesystem type (INITRD)  ---> EXT4 (SD/eMMC/SATA/USB) 
```

Save the configuration and press ESC until quit the application. Finally, build the image with the following command:

```bash
 $ petalinux-build
```

This last command takes a long time. Go take a coffee !

## Adding meta-fred Layer to a petalinux Project

Now we add the meta-fred Yocto layer, following similar steps as in this [link](https://www.zachpfeffer.com/single-post/Add-a-Yocto-Layer-to-a-PetaLinux-Project-and-Build-a-Recipe-in-the-Layer-with-PetaLinux-Tools), with some simplications:

```bash
$ mkdir -p components/ext_source
$ cd components/ext_source
$ git clone https://github.com/fred-framework/meta-fred.git
$ cd ../..
$ petalinux-config
```
In `petalinux-config`, follow these steps util reaching `user layer 0`:

```
Yocto Settings ---> User Layers ---> user layer 0
```

Then write the path to the layer:

```bash
${PROOT}/components/ext_source/meta-fred
```

Back in the terminal, run: 

```bash
 cat build/conf/bblayers.conf 
 ...
  /<basedir>/pynq-2020.2/components/ext_source/meta-fred \
  "
```

and we should see the new layer inserted.

Finally, we build the image again, this time including meta-fred recipes:

```bash
$ petalinux-build
```

This time the build process will take only a couple of minutes.

These are some useful commands to show the new recipes:

```bash
$ source ./components/yocto/layers/core/oe-init-build-env
$ bitbake-layers show-layers
NOTE: Starting bitbake server...
layer                 path                                      priority
==========================================================================
meta                  /ssd/work/petalinux/2020.2/pynq-2020.2/pynq-2020.2/components/yocto/layers/core/meta  5
...
workspace             /ssd/work/petalinux/2020.2/pynq-2020.2/pynq-2020.2/components/yocto/workspace  99
meta-fred             /ssd/work/petalinux/2020.2/pynq-2020.2/pynq-2020.2/components/ext_source/meta-fred  7

$ bitbake-layers show-recipes > recipes.txt
$ grep -i mgr recipes.txt
efibootmgr:
fpga-mgr-zynqmp-drv:
$ grep -i fred recipes.txt
  meta-fred            1.0
fred-buffctl:
  meta-fred            1.0
fred-lib:
  meta-fred            1.0
fred-server:
  meta-fred            1.0
fred-tutorial:
  meta-fred            1.0
```

**TODO**: a zynq device should show `fpga-mgr-zynq-drv` when running `grep -i mgr recipes.txt`. 


```
$ bitbake -e fred-lib | grep ^WORKDIR=
WORKDIR="/<basedir>/xilinx-zcu102-2020.2/build/tmp/work/aarch64-xilinx-linux/fred-lib/1.0-r0"
```


% cat build/tmp/deploy/licenses/petalinux-image-minimal-zynq-generic-20211228154035/package.manifest  | grep fred
fed-lib
fred-lib-dev
fred-lib-lic
fred-server
fred-server-lic
fred-tutorial
fred-tutorial-lic

## Running the Custom Apps with QEMU

TO BE DONE !
https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/821395464/QEMU+User+Documentation
https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/862421112/Co-simulation

petalinux-boot --qemu --prebuilt 3

petalinux-boot --qemu --image ./images/linux/zImage

To quit the emulation, press CTRL+A followed by X.

## Running the Custom Apps in the FPGA


petalinux-package --boot --format BIN --fsbl images/linux/zynq_fsbl.elf --kernel images/linux/image.ub --u-boot images/linux/u-boot.elf --fpga images/linux/<NAME_OF_BITSREAM>.bit



Remember that the `/mnt/yocto/tmp` is shared between the docker image and the host, so it's easy to burn the image file into an SD card.

Return to the host computer and run `df` to find out the SD card device (assuming it is `/dev/sdb`) and run:

```bash
$ sudo dd if=/<host mounting point>/deploy/images/raspberrypi3/core-image-minimal-raspberrypi3.rpi-sdimg of=/dev/sdb bs=4M
```

Check out more information on these links:

 - https://george-calin.medium.com/how-to-prepare-a-helloworld-c-recipe-with-yocto-project-1f74c296a777
 - https://tutorialadda.com/yocto/create-your-own-linux-image-for-the-raspberry-pi-board-using-yocto-project


## TO DO

 - [ ] build the correct kernel module based on the FPGA model , e.g. `zynq` or `zynqmp`;
 - [ ] include the device tree from DART;
 - [ ] make a [cmake module](https://gitlab.kitware.com/cmake/community/-/wikis/doc/tutorials/How-To-Find-Libraries) for `fred-lib`;
 - [ ] Use [SystemC cosim](https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/862421112/Co-simulation) for testing FRED;
 - [ ] write a [QEMU device model](https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/861569267/QEMU+Device+Model+Development) for testing FRED;

## Contributions

  Did you find a bug in this tutorial ? Do you have some extensions or updates to add ? Please send me a Pull Request.

## Authors

 - Alexandre Amory (April 2021), ReTiS Lab, Scuola Sant'Anna, Pisa, Italy.

## Funding
 
This software package has been developed in the context of the [AMPERE project](https://ampere-euproject.eu/). This project has received funding from the European Unionâ€™s Horizon 2020 research and innovation programme under grant agreement No 871669.
